<!doctype html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/><title>hyperbo.la :: Postmortem: 502s During Parameter Store Rollout</title><meta property="og:site_name" content="hyperbo.la"/><meta property="og:url" content="https://hyperbo.la/w/secrets-in-parameter-store-postmortem/"/><meta property="og:image" content="https://hyperbo.la/logo.png"/><meta property="og:type" content="article"/><meta property="og:article:published_time" content="2018-11-16T00:00:00.000+00:00"/><meta property="og:article:modified_time" content="2018-11-16T00:00:00.000+00:00"/><meta property="og:article:author" content="https://www.facebook.com/ryan.lopopolo"/><meta property="og:title" content="Postmortem: 502s During Parameter Store Rollout"/><meta property="og:description" content="Terraform misconfiguration of SSM PrivateLink endpoint completely brings down hyperbo.la."/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="msapplication-TileColor" content="#222222"/><meta name="theme-color" content="#222222"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-30651847-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-30651847-1")</script><link href="/main.6f6144d5f8104c818c62.css" rel="stylesheet"></head><body class="blog"><div class="container mb-5"><nav class="navbar navbar-expand-md"><a class="navbar-brand p-0" href="/" aria-label="hyperbola"><img class="float-left" title="hyperbola" alt="Hyperbola logo" src="/ea3a0c4f0b6d4c1600f0444f02ac44d9.svg"/> <span class="sr-only">hyperbola</span> </a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto"><div class="container d-flex flex-column flex-md-row justify-content-end"><li class="nav-item"><a class="nav-link nav-link-frontpage" href="/">home</a></li><li class="nav-item"><a class="nav-link nav-link-contact" href="/contact/">contact</a></li><li class="nav-item"><a class="nav-link nav-link-lifestream" href="/lifestream/">lifestream</a></li><li class="nav-item"><a class="nav-link nav-link-blog" href="/w/">blog</a></li></div></ul></div></nav><div class="card hyperbola-section-title my-3 w-100"><div class="card-body"><span class="card-title"><strong>hyperbo.la :: Postmortem: 502s During Parameter Store Rollout</strong></span></div></div><div class="row"><div class="col-lg-9 mx-auto"><div class="card mb-3"><div class="card-body"><h2 class="card-title text-center"><a href="/w/secrets-in-parameter-store-postmortem/">Postmortem: 502s During Parameter Store Rollout</a></h2><div class="h6 card-subtitle text-center mb-2 hyperbola-text-timestamp"><a href="/contact/">Ryan Lopopolo</a> | November 16, 2018</div><div class="card-text"><p>Attempting to deploy <a href="https://github.com/lopopolo/hyperbola/tree/v0.149.2">0.149.2</a> brought down <a href="https://hyperbo.la/">hyperbo.la</a> and caused all requests to return 502 status code. Root cause is a misconfigured PrivateLink endpoint and an unsafe ASG cycler script.</p><h3 id="context">Context</h3><p>Since 2014, <a href="https://hyperbo.la/">hyperbo.la</a> secrets were distributed via <a href="https://github.com/lopopolo/hyperbola/commit/8f08b3d8fc07bbde7f0098ec52604cd2062c0715#diff-2378b82d75acb7d14d7df6a2389e8a02">flat files</a> with each deployment. <code>.env</code> files were necessary when <a href="https://hyperbo.la/">hyperbo.la</a> was a single Linode VPS, but AWS has better tools for distributing secrets.</p><p><a href="https://github.com/lopopolo/hyperbola/pull/100">GH-100</a> converted <code>settings.py</code> to fetch secrets from <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-paramstore.html">SSM Parameter Store</a>.</p><p>App backend instances run in private VPC subnets with no Internet egress. Packer builds run in a single public VPC subnet with a public IP.</p><p>I recently refactored terraform config to use a launch template instead of a launch configuration. Deploys are now managed by an untested <a href="https://github.com/lopopolo/hyperbola/blob/v0.149.2/bin/cycle_asg">ASG cycler script</a>.</p><p>0.149.0 includes a new task runner which includes a new and untested deploy task, <code>inv deploy</code>, and a rollback task, <code>inv deploy.rollback</code>.</p><h3 id="timeline">Timeline</h3><h4 id="01491">0.149.1</h4><ul><li>[2018-11-10 22:11] Build fails due to <a href="https://github.com/lopopolo/hyperbola/commit/f69a09882b665e5b83f0e1d61b8b03ba304be76b">malformed Ansible config</a>.</li></ul><h4 id="01492">0.149.2</h4><ul><li>[2018-11-11 00:04] <code>inv deploy</code> kicks off Packer build.</li><li>[00:15] <code>inv deploy</code> finishes cycling the ASG.</li><li>[00:16] Manual smoke test of <code>https://hyperbo.la/</code> shows nginx 502 page.</li><li>[00:17] Uptime Robot reports <a href="https://hyperbo.la/">hyperbo.la</a> hard down.</li><li>[00:17] <code>inv deploy.rollback</code>.</li><li>[00:19] <code>inv deploy.rollback</code> finishes cycling the ASG.</li><li>[00:20] Manual smoke test of <code>https://hyperbo.la/</code> shows we are recovered.</li><li>[00:23] Uptime Robot reports we are back up.</li><li>[01:08]<a href="https://github.com/lopopolo/hyperbola/commit/8ad4fe11dd4b66d476262a101ed7ad9ae9c9cdd4">reconfigure ssm endpoint security groups</a>.</li><li>[01:09] Attempt to deploy 0.149.2 again.</li><li>[01:11] Manual smoke test of <code>https://hyperbo.la/</code> shows nginx 502 page.</li><li>[01:13] <code>inv deploy.rollback</code>.</li><li>[01:14] <code>inv deploy.rollback</code> finishes cycling the ASG.</li><li>[01:15] Manual smoke test of <code>https://hyperbo.la/</code> shows we are recovered.</li><li>[01:19] Enable <a href="https://github.com/lopopolo/hyperbola/commit/e04efe78b5b1be082facb9d4a255453acb18e0ff">private DNS for SSM endpoint</a>.</li><li>[01:22] Attempt to deploy 0.149.2 again.</li><li>[01:25] Manual smoke test of <code>https://hyperbo.la/</code> shows deploy succeeds.</li><li>[01:26] <code>https://hyperbo.la/healthz</code> confirms 0.149.2 is deployed.</li></ul><p>At this point the incident is mitigated but <a href="https://hyperbo.la/">hyperbo.la</a> is undeployable.</p><h4 id="01493">0.149.3</h4><ul><li>[08:59] Cut 0.149.3 to package terraform changes into a release and clean up.</li><li>[09:07] <code>inv deploy</code> kicks off Packer build.</li><li>[09:11] <code>inv deploy.ami</code> fails when running <code>manage.py collectstatic</code>.</li></ul><p>At this point I spent time to deep dive into VPC terraform to properly <a href="https://github.com/lopopolo/hyperbola/commit/1a6b56247094faaaa57b40fbc5507994a65f53c5">configure the SSM PrivateLink endpoint</a>.</p><h4 id="01494">0.149.4</h4><ul><li>[18:48] <code>inv deploy</code> kicks off Packer build.</li><li>[18:59] Packer build finishes successfully.</li><li>[19:05] <code>inv deploy</code> finishes cycling the ASG.</li><li>[19:06] Manual smoke test of <code>https://hyperbo.la/</code> shows deploy succeeds.</li></ul><p>At this point, the incident is over and we are stable.</p><h3 id="root-cause-analysis">Root Cause Analysis</h3><h4 id="implemented-ssm-privatelink-endpoint-without-reading-documentation">Implemented SSM PrivateLink endpoint without reading documentation</h4><p>For most AWS features, the terraform documentation is descriptive enough that implementation is straightforward. PrivateLink was non-trivial to set up. Errors I made:</p><ul><li>Did not allow egress from Packer builder to endpoint.</li><li>Did not allow ingress to endpoint from Packer.</li><li>Did not allow egress from app backend to endpoint.</li><li>Did not allow ingress to endpoint from app backend.</li><li>Did not enable private DNS for zero-configuration use with boto3.</li></ul><h4 id="asg-cycler-did-not-validate-instances-are-healthy-in-alb">ASG cycler did not validate instances are healthy in ALB</h4><p>The ALB already hits <code>/healthz</code>. Automate checking that hosts come up cleanly to not rely on manual smoke testing. Automatically detach unhealthy hosts from the ALB and halt the rollout.</p><h3 id="remediation-items">Remediation Items</h3><ul><li><a href="https://github.com/lopopolo/hyperbola/issues/103">GH-103</a>: add ALB healthchecks to <code>cycle_asg</code> script.</li><li><a href="https://github.com/lopopolo/hyperbola/pull/101">GH-101 (Done)</a>: create a management domain in VPC for shared infrastructure.</li><li><a href="https://github.com/lopopolo/hyperbola/commit/f8fe09f9bf30864ed5a814fdbb7116ca3d279bad">Done</a>: add a lab terraform environment for testing VPC changes.</li><li><a href="https://github.com/lopopolo/hyperbola/issues/104">GH-104</a>: export instance journald logs for gunicorn and nginx to CloudWatch.</li></ul></div></div></div></div></div></div><script src="/main.7266f7bcaf2da31450ad.js"></script></body></html>